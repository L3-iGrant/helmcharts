services:
  postgres:
    image: ${POSTGRES_IMAGE:-europe-docker.pkg.dev/jenkins-189019/igrant-customers/igrant-api/postgres:2025.1.1}
    container_name: ${POSTGRES_CONTAINER_NAME:-postgres}
    environment:
      POSTGRES_USER: ${POSTGRES_USERNAME:-dbadmin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-dbadmin}
      POSTGRES_DB: ${POSTGRES_DATABASE:-kcdb}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USERNAME:-dbadmin}"]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    image: ${KEYCLOAK_IMAGE:-europe-docker.pkg.dev/jenkins-189019/igrant-customers/igrant-api/keycloak:12.0.4-debian-10-r1}
    container_name: ${KEYCLOAK_CONTAINER_NAME:-keycloak}
    environment:
      KEYCLOAK_USER: ${KEYCLOAK_ADMIN_USERNAME:-kcadmin}
      KEYCLOAK_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-kcadmin}
      KEYCLOAK_DATABASE_HOST: ${POSTGRES_CONTAINER_NAME:-postgres}
      KEYCLOAK_DATABASE_PORT: 5432
      KEYCLOAK_DATABASE_NAME: ${POSTGRES_DATABASE:-kcdb}
      KEYCLOAK_DATABASE_USER: ${POSTGRES_USERNAME:-dbadmin}
      KEYCLOAK_DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-dbadmin}
    ports:
      - "${KEYCLOAK_PORT:-8082}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  mongo:
    image: ${MONGO_IMAGE:-europe-docker.pkg.dev/jenkins-189019/igrant-customers/igrant-api/mongodb:7.0-debian-12}
    container_name: ${MONGO_CONTAINER_NAME:-mongo}
    environment:
      MONGODB_ROOT_USER: ${MONGO_USERNAME:-dbadmin}
      MONGODB_ROOT_PASSWORD: ${MONGO_PASSWORD:-dbadmin}
      MONGODB_DATABASE: ${MONGO_DATABASE:-owsdb}
    volumes:
      - mongo-data:/bitnami/mongodb
    ports:
      - "${MONGO_PORT:-27017}:27017"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  nats:
    image: ${NATS_IMAGE:-nats:2.10.14-alpine}
    container_name: ${NATS_CONTAINER_NAME:-nats}
    command: ["-js", "-sd", "/data"]
    volumes:
      - nats-data:/data
    ports:
      - "${NATS_PORT:-4222}:4222"
      - "${NATS_MONITOR_PORT:-8222}:8222"
    restart: unless-stopped

  vault-facade:
    image: ${VAULT_FACADE_IMAGE:-europe-docker.pkg.dev/jenkins-189019/igrant-customers/igrant-api/vault-facade:2026.1.1}
    container_name: ${VAULT_FACADE_CONTAINER_NAME:-vault-facade}
    environment:
      APP_MODE: ${VAULT_FACADE_APP_MODE:-mongo}
      MONGODB_HOST: ${MONGO_CONTAINER_NAME:-mongo}
      MONGODB_PORT: 27017
      MONGODB_USER: ${MONGO_USERNAME:-dbadmin}
      MONGODB_PASSWORD: ${MONGO_PASSWORD:-dbadmin}
      MONGODB_DATABASE: ${MONGO_DATABASE:-owsdb}
    ports:
      - "${VAULT_FACADE_PORT:-8081}:8080"
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped

  api:
    image: ${API_IMAGE:-europe-docker.pkg.dev/jenkins-189019/igrant-customers/igrant-api/api:2026.1.1}
    container_name: ${API_CONTAINER_NAME:-api}
    environment:
      MONGODB_HOST: ${MONGO_CONTAINER_NAME:-mongo}
      MONGODB_PORT: 27017
      MONGODB_DATABASE: ${MONGO_DATABASE:-owsdb}
      MONGODB_USER: ${MONGO_USERNAME:-dbadmin}
      MONGODB_PASSWORD: ${MONGO_PASSWORD:-dbadmin}
      IAM_URL: http://${KEYCLOAK_CONTAINER_NAME:-keycloak}:8080/auth
      IAM_REALM: ${IAM_REALM:-igrant-users}
      IAM_CLIENT_ID: ${IAM_CLIENT_ID:-igrant-ios-app}
      API_SECRET_KEY: ${API_SECRET_KEY:-your-api-secret-key}
      NATS_URL: nats://${NATS_CONTAINER_NAME:-nats}:4222
      NATS_TIMEOUT: ${NATS_TIMEOUT:-5}
      WEBHOOK_URL: http://${WEBHOOK_CONTAINER_NAME:-webhook}:8085/v2/
    ports:
      - "${API_PORT:-8080}:8080"
    depends_on:
      mongo:
        condition: service_healthy
      keycloak:
        condition: service_started
      nats:
        condition: service_started
    restart: unless-stopped

  webhook:
    image: ${API_IMAGE:-europe-docker.pkg.dev/jenkins-189019/igrant-customers/igrant-api/api:2026.1.1}
    command:
      - ./app/bin/igrant-api
      - start-webhook-api
      - --config
      - config-production.json
    container_name: ${WEBHOOK_CONTAINER_NAME:-webhook}
    environment:
      MONGODB_HOST: ${MONGO_CONTAINER_NAME:-mongo}
      MONGODB_PORT: 27017
      MONGODB_DATABASE: ${MONGO_DATABASE:-owsdb}
      MONGODB_USER: ${MONGO_USERNAME:-dbadmin}
      MONGODB_PASSWORD: ${MONGO_PASSWORD:-dbadmin}
    ports:
      - "${WEBHOOK_PORT:-8085}:8085"
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped

  organisation-wallet:
    image: ${OWS_IMAGE:-europe-docker.pkg.dev/jenkins-189019/igrant-customers/igrant-api/ows:2026.1.5}
    container_name: ${OWS_CONTAINER_NAME:-organisation-wallet}
    environment:
      DATABASE_HOST: ${MONGO_CONTAINER_NAME:-mongo}
      DATABASE_PORT: 27017
      DATABASE_DB: ${OWS_DATABASE:-walletdb}
      DATABASE_USER: ${MONGO_USERNAME:-dbadmin}
      DATABASE_PASSWORD: ${MONGO_PASSWORD:-dbadmin}
      SECURE_VAULT_BASE_URL: http://${VAULT_FACADE_CONTAINER_NAME:-vault-facade}:8080
      NATS_URL: nats://${NATS_CONTAINER_NAME:-nats}:4222
      API_BASE_URL: http://${API_CONTAINER_NAME:-api}:8080
    ports:
      - "${OWS_PORT:-8090}:8080"
    depends_on:
      mongo:
        condition: service_healthy
      vault-facade:
        condition: service_started
      nats:
        condition: service_started
    restart: unless-stopped

  enterprise-dashboard:
    image: ${DASHBOARD_IMAGE:-europe-docker.pkg.dev/jenkins-189019/igrant-customers/igrant-api/dashboard:2026.1.1}
    container_name: ${DASHBOARD_CONTAINER_NAME:-enterprise-dashboard}
    environment:
      API_BASE_URL: ${API_PUBLIC_URL:-http://localhost:8080}
    ports:
      - "${DASHBOARD_PORT:-3000}:80"
    depends_on:
      - api
    restart: unless-stopped

volumes:
  postgres-data:
    name: ${POSTGRES_VOLUME_NAME:-postgres-data}
  mongo-data:
    name: ${MONGO_VOLUME_NAME:-mongo-data}
  nats-data:
    name: ${NATS_VOLUME_NAME:-nats-data}
